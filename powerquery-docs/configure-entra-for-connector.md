---
title: Configuring Entra for a Custom Connector
description: Quickstart guide for enabling Entra support for a custom connector.
author: mattmasson
ms.topic: conceptual
ms.date: 3/12/2024
ms.author: mmasson
---

# Quickstart: Configuring Entra for a Custom Connector

This guide describes the steps to configure a Microsoft Entra application for use with a Power Query custom connector.
It is recommended that connector developers review the [concepts of the Microsoft identity platform](/entra/identity-platform/v2-overview) before proceeding.

Since the _Application_ term is used in multiple contexts in the Entra platform, this guide will use the following terms to distinguish between _connector_ and _data source_ application IDs:

* **Client Application**: The Entra client IDs that will be used by the Power Query connector.
* **Resource Application**: The Entra application registration for the endpoint the connector will connect to (i.e. your service, or data source).

Enabling Entra support for a custom connector involves:

* Defining one or more [scopes](/entra/identity-platform/developer-glossary#scopes) in the Resource Application that will be used by the connector.
* Pre-authorizing the Power Query client IDs to use those scopes.
* Setting the correct `Resource` and `Scopes` values in the connector definition.

This guide assumes a new Resource Application will be registered in Entra. Developers with an existing Resource Application can skip to the [Configure a Scope](#configure-a-scope) section.

> [!NOTE]
> For more details on using Entra in your service or application, please see one of the [Quickstart guides](/entra/identity-platform/quickstart-register-app).

## Register the Resource Application

Your data source or API endpoint will use this Resource Application to establish trust between your service and the Microsoft identity platform.

Follow these steps to register a new Resource Application:

1. Sign in to the [Microsoft Entra admin center](https://entra.microsoft.com/) as at least a [Cloud Application Administrator](/entra/identity/role-based-access-control/permissions-reference#cloud-application-administrator).
2. Browse to **Identity > Applications > App registrations** and select **New registration**.
3. Enter a display **Name** for your application.
4. For **Supported account types**, select **Accounts in this organizational directory only** if your endpoint is only accessible from within your organization. Select **Accounts in any organizational directory** for publicly accessible, multitenant services.
5. Select **Register**.

You do not need to specify a **Redirect URI** value.

The application's **Overview** page will be diplayed when the registration is complete. Take note of the **Directory (tenant) ID** and the **Application (client) ID** values as they will be used in your service's source code. Follow one of the guides in the [Microsoft identity platform code samples](/entra/identity-platform/sample-v2-code?tabs=apptype) that resembles your service environment and architecture to determine how to configure and make use of your new application.

## Set an Application ID URI

Before you can [configure a scope](#configure-a-scope) for your endpoint, you must set an **Application ID URI** for your Resource Application. This ID will be
used by the `Resource` field of the `Aad` record in your connector. The value is generally set to the root URL of your service. You can also use the default generated by Entra - `api://{clientId}` - where `{clientId}` is your Resource Application's client id.

1. Go to the Resource Application's **Overview** page.
2. On the center screen, under **Essentials**, select **Add an application ID URI**.
3. Enter a URI or accept the default based on your app id.
4. Select **Save and continue**.

The examples in this guide will assume you're using the default Application ID URI format (for example - `api://44994a60-7f50-4eca-86b2-5d44f873f93f`).

## Configure a Scope

[Scopes](/entra/identity-platform/developer-glossary#scopes) are used to define permissions or capabilities to access APIs or data in your service. The list of supported scopes are service specific. You'll want to determine a minimal set of scopes required by your connector. You'll need to preauthorize at least one scope for the Power Query client IDs.

If your Resource Application already has scopes defined, you can skip to the [next step](#preauthorize-the-power-query-client-applications).

If your service does not use scope based permissions, you can still define a single scope that will be used by the connector. You can (optionally) make use of this scope in your service code in the future.

In this example, we'll define a single scope called `Data.Read`.

1. Go to the Resource Application's **Overview** page.
2. Under **Manage**, select **Expose an API > Add a scope**.
3. For **Scope name**, enter `Data.Read`.
4. For **Who can consent**, select the **Admins and users** option.
5. Fill out the remaining display name and description boxes.
6. Ensure that **State** is set to **Enabled**.
7. Select **Add scope**.

## Preauthorize the Power Query Client Applications

Power Query connectors will use two different Entra client IDs. Preauthorizing scope(s) for these client IDs simplifies the connection experience.

| Client ID | Application Name | Used By |
| :-------- | :--------------- | :------ |
| a672d62c-fc7b-4e81-a576-e60dc46e951d | Power Query for Excel | Desktop environments |
| b52893c8-bc2e-47fc-918b-77022b299bbc | Power BI Data Refresh | Service environments |

To preauthorize the Power Query client IDs:

1. Go to the Resource Application's **Overview** page.
2. Under **Manage**, select **Expose an API**.
3. Select **Add a client application**.
4. Enter one of the Power Query Client IDs.
5. Select the appropriate **Authorized scopes**.
6. Select **Add application**.
7. Repeat steps 3 - 6 for each Power Query Client ID.

## Enable the Aad Authentication Kind in your Connector

Entra ID support is enabled for your connector by adding the `Aad` authentication kind to your connector's data source record.

```powerquery-m
MyConnector = [
    Authentication = [
        Aad = [
            AuthorizationUri = "https://login.microsoftonline.com/common/oauth2/authorize",
            Resource = "{YourApplicationIdUri}"
            Scope = ".default"
        ]
    ]
];
```

Replace the `{YourApplicationIdUri}` value with the **Application ID URI** value for your Resource Application (For example - `api://44994a60-7f50-4eca-86b2-5d44f873f93f`).

In this example:

* **AuthorizationUri**: Is the Entra URL used to initiate the authentication flow. Most connectors can hardcode this value to `https://login.microsoftonline.com/common/oauth2/authorize`, but it can also be determined dynamically if your service supports Azure B2B/Guest Accounts (see [samples](handling-authentication.md#aad-authentication-kind-samples)).
* **Resource**: The Application ID URI of your connector.
* **Scope**: Use the [.default](/entra/identity-platform/scopes-oidc#the-default-scope) scope to automatically receive all preauthorized scopes. Using `.default` allows you to change the required connector scopes in your Resource Application registration, without needing to update your connector.

See the [Entra ID Authentication Samples page](handling-authentication.md#microsoft-entra-id-authentication) for more details and options for configuring Entra support in your connector.

Rebuild your connector, and you should now be able to authenticate with your service using Entra ID.

## Troubleshooting

This section describes common errors you might receive if your Entra application is misconfigured.

### Power Query application has not been pre-authorized

> access_denied: AADSTS650057: Invalid resource. The client has requested access to a resource which is not listed in the requested permissions in the client's application registration. Client app ID: a672d62c-fc7b-4e81-a576-e60dc46e951d(Microsoft Power Query for Excel). Resource value from request: 44994a60-7f50-4eca-86b2-5d44f873f93f. Resource app ID: 44994a60-7f50-4eca-86b2-5d44f873f93

You might see this error if your Resource Application has not preauthorized the Power Query Client Applications. Follow the steps to [preauthorize the Power Query client IDs](#preauthorize-the-power-query-client-applications).

### Connector's Aad record is missing a Scope value

> access_denied: AADSTS650053: The application 'Microsoft Power Query for Excel' asked for scope 'user_impersonation' that doesn't exist on the resource '44994a60-7f50-4eca-86b2-5d44f873f93f'. Contact the app vendor.

Power Query will request the `user_impersonation` scope if the connector's `Aad` record does not define a `Scope` field, or the `Scope` value is `null`. You can resolve this issue by defining a `Scope` value in the connector. Using the `.default` scope is recommended, but you can also specify scopes at the connector level (for example - `Data.Read`).

### Scope or client application requires admin approval

> Need admin approval. &lt;tenant&gt; needs permission to access resources in your organization that only an admin can grant. Please as an admin to grant permission to this app before you can use it.

A user might receive this error during their authentication flow if your Resource Application requires [admin-restricted permissions](/entra/identity-platform/scopes-oidc#admin-restricted-permissions) or the user's tenant prevents non-admin users from consenting to new application permission requests. You can avoid this issue by ensuring your connector doesn't require any admin-restricted scopes and [preauthorizing the Power Query client IDs](#preauthorize-the-power-query-client-applications) for your Resource Application.
